<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        margin-top: 80px;
      }
      input, button {
        font-size: 16px;
        padding: 10px;
        margin: 5px;
      }
      #response {
        margin-top: 20px;
        font-weight: bold;
      }
      #loginModal {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      #loginBox {
        background: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        width: 300px;
      }
    </style>
  </head>

  <body>
    <h2>Meal Voucher Redemption</h2>
    <div id="operatorDisplay"></div>

    <div id="loginModal">
      <div id="loginBox">
        <h3>Enter Operator Name</h3>
        <input type="text" id="firstName" placeholder="First Name" /><br />
        <input type="text" id="lastName" placeholder="Last Name" /><br />
        <button onclick="submitLogin()">Login</button>
      </div>
    </div>

    <br />
    <input type="text" id="voucherInput" placeholder="Enter or scan voucher code" autofocus />
    <br />
    <button onclick="validateVoucher()">Validate Voucher</button>
    <div id="response"></div>

    <script>
      const endpoint = "https://script.google.com/macros/s/AKfycbzoiMeh_L-sI7bhdg05R8Yf7jMQVKVhcv2Ntux5dlxaeOB--1VEdS0WHLtU2kTaqjDxKA/exec";
      let operator = "";

      function formatName(name) {
        return name.replace(/\b\w/g, c => c.toUpperCase()).trim();
      }

      function submitLogin() {
        const fName = document.getElementById("firstName").value.trim();
        const lName = document.getElementById("lastName").value.trim();

        if (!fName || !lName) {
          alert("Please enter both first and last name.");
          return;
        }

        operator = `${formatName(fName)} ${formatName(lName)}`;
        sessionStorage.setItem("operatorName", operator);
        document.getElementById("operatorDisplay").innerText = "Logged in as: " + operator;
        document.getElementById("loginModal").style.display = "none";
        document.getElementById("voucherInput").focus();
      }

      window.onload = function () {
        const stored = sessionStorage.getItem("operatorName");
        if (stored) {
          operator = stored;
          document.getElementById("operatorDisplay").innerText = "Logged in as: " + operator;
          document.getElementById("loginModal").style.display = "none";
        }
      };

      function validateVoucher() {
        const voucher = document.getElementById("voucherInput").value.trim();
        const responseBox = document.getElementById("response");

        if (!voucher) return;

        responseBox.innerHTML = "Validatingâ€¦";
        responseBox.style.color = "black";

        fetch(endpoint, {
          method: "POST",
          body: JSON.stringify({
            voucherKey: voucher,
            operator: operator,
            source: "web"
          }),
          headers: { "Content-Type": "application/json" }
        })
          .then(res => res.json())
          .then(data => {
            if (data.result === "Redeemed") {
              responseBox.innerHTML = "Voucher Redeemed";
              responseBox.style.color = "green";
            } else if (data.result === "Already Redeemed") {
              responseBox.innerHTML = "Already Redeemed";
              responseBox.style.color = "orange";
            } else if (data.result === "ERROR") {
              responseBox.innerHTML = "ERROR: " + (data.message || "Unknown issue");
              responseBox.style.color = "red";
            } else {
              responseBox.innerHTML = "Invalid Voucher";
              responseBox.style.color = "gray";
            }

            document.getElementById("voucherInput").value = "";
            document.getElementById("voucherInput").focus();
          })
          .catch(error => {
            responseBox.innerHTML = "Fetch ERROR: " + error.message;
            responseBox.style.color = "red";
          });
      }
    </script>
  </body>
</html>
